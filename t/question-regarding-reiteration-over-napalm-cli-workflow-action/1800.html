<!DOCTYPE html>
<html lang="en" class="desktop-view not-mobile-device text-size-normal anon">
<head>
    <meta charset="utf-8">
    <title>Question regarding reiteration over napalm.cli workflow action - Workflows - StackStorm Support
        (ARCHIVED)</title>
    <meta name="description" content="I‚Äôve been digging around the forums and docs for a bit but haven‚Äôt come up with a good solution for this yet aside from replacing an action. 
I‚Äôve got the following workflow currently able to request very basic approval,&amp;hellip;">
    <meta name="discourse_theme_id" content="2">
    <meta name="discourse_current_homepage" content="latest">
    <meta name="generator"
          content="Discourse 2.8.0.beta6 - https://github.com/discourse/discourse version a1daf9fe53a66e2d2cdf9757ab4812fb9a2b2787">
    <link rel="icon" type="image/png"
          href="https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/optimized/1X/379ced12f8326d58f1b3d2b3ff652f883e141f6a_2_32x32.PNG">
    <link rel="apple-touch-icon" type="image/png"
          href="https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/optimized/1X/379ced12f8326d58f1b3d2b3ff652f883e141f6a_2_180x180.PNG">
    <meta name="theme-color" content="#ffffff">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <link rel="canonical" href="1800.html"/>
    <script type="application/ld+json">{
        "@context": "http://schema.org",
        "@type": "WebSite",
        "url": "https://forum.stackstorm.com",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://forum.stackstorm.com/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
    <link rel="search" type="application/opensearchdescription+xml" href="../../opensearch.xml"
          title="StackStorm Support (ARCHIVED) Search">


    <link href="/../../stylesheets/color_definitions_base__2_3c5eec1ecf192052ea70b4afdab57a62bccc0604.css?__ws=forum.stackstorm.com"
          media="all" rel="stylesheet" class="light-scheme"/>

    <link href="/../../stylesheets/desktop_b2f2968742d41481357e0df259b51ce29f72481a.css?__ws=forum.stackstorm.com"
          media="all" rel="stylesheet" data-target="desktop"/>


    <meta name="fragment" content="!">


    <link id="manifest-link" rel="manifest" href="../../manifest.webmanifest" crossorigin="use-credentials">


    <link rel="alternate" type="application/rss+xml"
          title="RSS feed of &#39;Question regarding reiteration over napalm.cli workflow action&#39;" href="1800.rss"/>
    <meta property="og:site_name" content="StackStorm Support (ARCHIVED)"/>
    <meta property="og:type" content="website"/>
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:image"
          content="https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/original/1X/891f00fbdb31fecb5bd9dab30c186d2fed0091ca.jpeg"/>
    <meta property="og:image"
          content="https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/original/1X/891f00fbdb31fecb5bd9dab30c186d2fed0091ca.jpeg"/>
    <meta property="og:url"
          content="https://forum.stackstorm.com/t/question-regarding-reiteration-over-napalm-cli-workflow-action/1800"/>
    <meta name="twitter:url"
          content="https://forum.stackstorm.com/t/question-regarding-reiteration-over-napalm-cli-workflow-action/1800"/>
    <meta property="og:title" content="Question regarding reiteration over napalm.cli workflow action"/>
    <meta name="twitter:title" content="Question regarding reiteration over napalm.cli workflow action"/>
    <meta property="og:description"
          content="I‚Äôve been digging around the forums and docs for a bit but haven‚Äôt come up with a good solution for this yet aside from replacing an action.  I‚Äôve got the following workflow currently able to request very basic approval, and then push commands to a single host via the napalm.cli pack action. However, when using a different netbox inventory output, it‚Äôs not reiterating over the multiple names pushed in output, but doing the first and stopping.  I thought it‚Äôd be a quick ‚Äúwith items‚Äù fix to get th..."/>
    <meta name="twitter:description"
          content="I‚Äôve been digging around the forums and docs for a bit but haven‚Äôt come up with a good solution for this yet aside from replacing an action.  I‚Äôve got the following workflow currently able to request very basic approval, and then push commands to a single host via the napalm.cli pack action. However, when using a different netbox inventory output, it‚Äôs not reiterating over the multiple names pushed in output, but doing the first and stopping.  I thought it‚Äôd be a quick ‚Äúwith items‚Äù fix to get th..."/>
    <meta name="twitter:label1" value="Reading time"/>
    <meta name="twitter:data1" value="1 mins üïë"/>
    <meta name="twitter:label2" value="Likes"/>
    <meta name="twitter:data2" value="1 ‚ù§"/>
    <meta property="article:published_time" content="2021-08-06T04:52:33+00:00"/>
    <meta property="og:ignore_canonical" content="true"/>


    <script type="application/ld+json">{
        "@context": "http://schema.org",
        "@type": "QAPage",
        "name": "Question regarding reiteration over napalm.cli workflow action",
        "mainEntity": {
            "@type": "Question",
            "name": "Question regarding reiteration over napalm.cli workflow action",
            "text": "I‚Äôve been digging around the forums and docs for a bit but haven‚Äôt come up with a good solution for this yet aside from replacing an action.\n\nI‚Äôve got the following workflow currently able to request very basic approval, and then push commands to a single host via the napalm.cli pack action. However&hellip;",
            "upvoteCount": 0,
            "answerCount": 1,
            "dateCreated": "2021-08-06T04:52:33.195Z",
            "author": {
                "@type": "Person",
                "name": ""
            },
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "[image] knight:\n\nhostname: &lt;% ctx().json[0] %&gt;\n\nThat line  is selecting just the first entry in the JSON list of hosts so it will only run the action the single time.\n\nYou were correct that it should need the ‚Äúwith:items‚Äù setup to iterate over your list of hosts and run the command on all.  I t&hellip;",
                "upvoteCount": 1,
                "dateCreated": "2021-08-06T12:27:36.399Z",
                "url": "https://forum.stackstorm.com/t/question-regarding-reiteration-over-napalm-cli-workflow-action/1800/2",
                "author": {
                    "@type": "Person",
                    "name": "jamesdreid"
                }
            }
        }
    }
    </script>

    <meta id="data-discourse-setup" data-cdn="https://sjc6.discourse-cdn.com/standard10"
          data-base-url="https://forum.stackstorm.com" data-base-uri="" data-environment="production"
          data-letter-avatar-version="5_8fec8e114563efeaf5265573e510f08e"
          data-markdown-it-url="https://aws1.discourse-cdn.com/standard10/assets/markdown-it-bundle-31e9a9c535ca1801c26da78b0ff465821751a98f921c5cdc5457d7e5a69e9748.js"
          data-service-worker-url="service-worker.js" data-default-locale="en"
          data-asset-version="597e36448c9b51d0fa3b7e43ec1fd6d5" data-disable-custom-css="false"
          data-highlight-js-path="/highlight-js/forum.stackstorm.com/ac0f4aa001e1343346941766d72e0c1ae330832b.js"
          data-svg-sprite-path="/svg-sprite/forum.stackstorm.com/svg-2-c2ad434b1e06079c7e282124aed9938dc95b83ea.js"
          data-enable-js-error-reporting="true" data-color-scheme-is-dark="false" data-user-dark-scheme-id="-1"
          data-s3-cdn="https://aws1.discourse-cdn.com/standard10"
          data-s3-base-url="//discourse-cloud-file-uploads.s3.dualstack.us-west-2.amazonaws.com/standard10">

    <meta name="discourse/config/environment"
          content="%7B%22modulePrefix%22%3A%22discourse%22%2C%22environment%22%3A%22production%22%2C%22rootURL%22%3A%22%22%2C%22locationType%22%3A%22auto%22%2C%22historySupportMiddleware%22%3Afalse%2C%22EmberENV%22%3A%7B%22FEATURES%22%3A%7B%7D%2C%22EXTEND_PROTOTYPES%22%3A%7B%22Date%22%3Afalse%7D%2C%22_APPLICATION_TEMPLATE_WRAPPER%22%3Afalse%2C%22_DEFAULT_ASYNC_OBSERVERS%22%3Atrue%2C%22_JQUERY_INTEGRATION%22%3Atrue%7D%2C%22APP%22%3A%7B%22name%22%3A%22discourse%22%2C%22version%22%3A%222.8.0.beta6%20a1daf9fe53a66e2d2cdf9757ab4812fb9a2b2787%22%2C%22exportApplicationGlobal%22%3Atrue%7D%7D"/>
</head>

<body class="">


<header class="d-header">
    <div class="wrap">
        <div class="contents clearfix">
            <div class="title">
                <a href="../../index.html">
                    <picture>
                        <img src="https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/original/1X/843840296d4160717941c20e214d0772ce899ab0.png"
                             alt="StackStorm Support (ARCHIVED)" id="site-logo"/>
                    </picture>
                </a>
            </div>

        </div>
    </div>
</header>

<div id="main-outlet" class="wrap" role="main">
    <!-- preload-content: -->

    <!-- EOF START -->
    <div class="container" id="main-container">
        <div id="ember11" class="ember-view"></div>
        <div id="ember12" class="controls ember-view"><!----></div>
        <div id="ember13" class="ember-view"><!----></div>
        <div id="ember14" class="ember-view">
            <div class="row">
                <div id="global-notice-alert-read-only" class="alert alert-info alert-read-only">
                    <!----> <span class="text">This site is in read only mode. Please continue to browse, but replying, likes, and other actions are disabled for now.</span>

                    <!---->    </div>
            </div>
            <div class="row">
                <div id="global-notice-alert-global-notice" class="alert alert-info alert-global-notice">
                    <!----> <span class="text"><h3>‚ö†Ô∏è We've moved!</h3>  <p> Hi there!<br><br> To reduce project dependency on 3rd party paid services the StackStorm TSC has decided to move the Q/A from this forum to <a
                        href="https://github.com/StackStorm/st2/discussions">Github Discussions</a>. This will make user experience better integrated with the native Github flow, as well as the questions closer to the community where they can provide answers. </p>  <p> Use üîó <b><a
                        href="https://github.com/StackStorm/st2/discussions" class="active">Github Discussions</a></b> to ask your questions. </p></span>

                    <!---->    </div>
            </div>
        </div>
        <div id="ember17" class="hidden create-topics-notice ember-view"><!----></div>
        <!---->
    </div>
    <!-- EOF END -->
    <div id="topic-title">
        <h1>
            <a href="1800.html">Question regarding reiteration over napalm.cli workflow action</a>
        </h1>

        <div class="topic-category" itemscope itemtype="http://schema.org/BreadcrumbList">
          <span itemprop="itemListElement" itemscope itemtype="http://schema.org/ListItem">
            <a href="../../c/workflow-related-issues/15" class="badge-wrapper bullet" itemprop="item">
              <span class='badge-category-bg' style='background-color: #25AAE2'></span>
              <span class='badge-category clear-badge'>
                <span class='category-name' itemprop='name'>Workflows</span>
              </span>
            </a>
            <meta itemprop="position" content="1"/>
          </span>
        </div>

        <div class="topic-category">
            <div class='discourse-tags list-tags'>
                <a href='../../tag/yaql' class='discourse-tag' rel="tag">yaql</a>,
                <a href='../../tag/orquesta' class='discourse-tag' rel="tag">orquesta</a>
            </div>
        </div>
    </div>


    <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
            <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
                <meta itemprop='name' content='StackStorm'>
                <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                    <meta itemprop='url'
                          content='https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/original/1X/843840296d4160717941c20e214d0772ce899ab0.png'>
                </div>
            </div>
            <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://github.com/knight'><span itemprop='name'>knight</span></a>
            
          </span>

            <link itemprop="mainEntityOfPage" href="1800.html">


            <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2021-08-06T04:52:33Z' class='post-time'>
                August 6, 2021,  4:52am
              </time>
              <meta itemprop='dateModified' content='2021-08-06T04:52:33Z'>
          <span itemprop='position'>#1</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
            <p>I‚Äôve been digging around the forums and docs for a bit but haven‚Äôt come up with a good solution for this
                yet aside from replacing an action.</p>
            <p>I‚Äôve got the following workflow currently able to request very basic approval, and then push commands to
                a single host via the napalm.cli pack action. However, when using a different netbox inventory output,
                it‚Äôs not reiterating over the multiple names pushed in output, but doing the first and stopping.</p>
            <p>I thought it‚Äôd be a quick ‚Äúwith items‚Äù fix to get the task to repeat over resulting hosts however the
                napalm.cli action does not support ‚Äúwith items‚Äù and causes an error stoppage. I can‚Äôt think of a decent
                method around this aside from replacing the napalm.cli task with an ansible playbook doing the legwork
                in it‚Äôs place.</p>
            <p>If there‚Äôs another way to do this that I‚Äôm looking over - any push to a doc/kb article or assistance
                would be great!</p>
            <p>Here‚Äôs my workflow being used, debug output of the ‚Äújson‚Äù output parameter is simply a list of hostnames
                in string format for the action input.</p>
            <pre><code class="lang-auto">#version: 1.0

input:
  - site
  - tag
  - commands
  
tasks:
  # [116, 137]
  get_approval:
    action: core.ask
    input:
      schema:
        type: object
        properties:
          approved:
            type: boolean
            description: "Do you have Approval?"
            required: True
          ticket_id:
            type: string
            description: "Ticket (CR/IR) ID:"
            required: True
      ttl: 90
    next:
      - when: &lt;% task(get_approval).result.response.approved = true %&gt;
        publish:
          - approver_department_id: &lt;% task(get_approval).result.response.ticket_id %&gt;
        do: get_inventory
      - when: &lt;% task(get_approval).result.response.approved = false %&gt;
        do: fail
  # [116, 314]
  get_inventory:
    action: netbox.get.dcim.devices
    next:
      - publish:
          - stdout: &lt;% result().exit_code %&gt;
          - stderr: &lt;% result().stderr %&gt;
          - json: &lt;% result().result.raw.results.name %&gt;
        do:
          - push_commands
    input:
      log_level: DEBUG
      site: &lt;% ctx().site %&gt;
      tag: &lt;% ctx().tag %&gt;
      save_in_key_store: false
  # [116, 493]
  push_commands:
    action: napalm.cli
    input:
      log_level: DEBUG
      commands:
        - &lt;% ctx().commands %&gt;
      hostname: &lt;% ctx().json[0] %&gt;
      driver: junos
    next:
      - do:
          - notify
  # [116, 629]
  notify:
    action: ansible.playbook
    input:
      cwd: {{ Redacted }}/notify/
      playbook: main.yml
      extra_vars:
        - '@extras/napalm_nbx_success.json'
 # remove success.json and get actual input next (low priority)
</code></pre>
        </div>

        <meta itemprop='headline' content='Question regarding reiteration over napalm.cli workflow action'>
        <meta itemprop='keywords' content='yaql, orquesta'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
            <meta itemprop="userInteractionCount" content="0"/>
            <span class='post-likes'></span>
        </div>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="1"/>
        </div>

    </div>
    <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
            <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
                <meta itemprop='name' content='StackStorm'>
                <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                    <meta itemprop='url'
                          content='https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/original/1X/843840296d4160717941c20e214d0772ce899ab0.png'>
                </div>
            </div>
            <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://github.com/jamesdreid'><span
                    itemprop='name'>jamesdreid</span></a>
            (James Reid)
          </span>

            <link itemprop="mainEntityOfPage" href="1800.html">


            <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2021-08-06T12:27:36Z' class='post-time'>
                August 6, 2021, 12:27pm
              </time>
              <meta itemprop='dateModified' content='2021-08-06T12:27:36Z'>
          <span itemprop='position'>#2</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
            <aside class="quote no-group" data-username="knight" data-post="1" data-topic="1800">
                <div class="title">
                    <div class="quote-controls"></div>
                    <img alt="" width="20" height="20"
                         src="https://sjc6.discourse-cdn.com/standard10/user_avatar/forum.stackstorm.com/knight/40/432_2.png"
                         class="avatar"> knight:
                </div>
                <blockquote>
                    <p><code>hostname: &lt;% ctx().json[0] %&gt;</code></p>
                </blockquote>
            </aside>
            <p>That line is selecting just the first entry in the JSON list of hosts so it will only run the action the
                single time.</p>
            <p>You were correct that it should need the ‚Äúwith:items‚Äù setup to iterate over your list of hosts and run
                the command on all. I think the task will need to look something like the following:</p>
            <pre><code class="lang-auto">push_commands:
    with:
      items: &lt;% ctx().json %&gt;
      concurrency: 10
    action: napalm.cli
    input:
      log_level: DEBUG
      commands:
        - &lt;% ctx().commands %&gt;
      hostname: &lt;% item() %&gt;
      driver: junos
    next:
      - do:
          - notify
  # [116, 629]
  notify:
    action: ansible.playbook
    input:
      cwd: {{ Redacted }}/notify/
      playbook: main.yml
      extra_vars:
        - '@extras/napalm_nbx_success.json'
 # remove success.json and get actual input next (low priority)
</code></pre>
            <p>I copied and paste your text so the indentation may be off but the commands and variables should be
                correct so YMMV. Also, with the concurrency option set to 10 will run 10 actions at a time and may need
                to be tweaked for your environment.</p>
        </div>

        <meta itemprop='headline' content='Question regarding reiteration over napalm.cli workflow action'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
            <meta itemprop="userInteractionCount" content="1"/>
            <span class='post-likes'>1 Like</span>
        </div>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0"/>
        </div>

    </div>
    <div itemscope itemtype='http://schema.org/DiscussionForumPosting' class='topic-body crawler-post'>
        <div class='crawler-post-meta'>
            <div itemprop='publisher' itemscope itemtype="http://schema.org/Organization">
                <meta itemprop='name' content='StackStorm'>
                <div itemprop='logo' itemscope itemtype="http://schema.org/ImageObject">
                    <meta itemprop='url'
                          content='https://aws1.discourse-cdn.com/standard10/uploads/stackstorm/original/1X/843840296d4160717941c20e214d0772ce899ab0.png'>
                </div>
            </div>
            <span class="creator" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <a itemprop="url" href='https://github.com/knight'><span itemprop='name'>knight</span></a>
            
          </span>

            <link itemprop="mainEntityOfPage" href="1800.html">


            <span class="crawler-post-infos">
              <time itemprop='datePublished' datetime='2021-08-06T15:54:13Z' class='post-time'>
                August 6, 2021,  3:54pm
              </time>
              <meta itemprop='dateModified' content='2021-08-06T15:54:13Z'>
          <span itemprop='position'>#3</span>
          </span>
        </div>
        <div class='post' itemprop='articleBody'>
            <p>Thanks for the help!</p>
            <p>Your answer got it working immediately. Comparing a backup of the workflow to yours, I had placed the
                with:items in an incorrect spot within the action (placed it at the bottom just above ‚Äúnext -do‚Äù and I
                guess it was parsing improperly.</p>
            <p>Sorry for leaving in the [0], that was from a test pushing to just one device (and forcing it to stay
                that way). I didn‚Äôt catch that I left it there.</p>
        </div>

        <meta itemprop='headline' content='Question regarding reiteration over napalm.cli workflow action'>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/LikeAction"/>
            <meta itemprop="userInteractionCount" content="0"/>
            <span class='post-likes'></span>
        </div>

        <div itemprop="interactionStatistic" itemscope itemtype="http://schema.org/InteractionCounter">
            <meta itemprop="interactionType" content="http://schema.org/CommentAction"/>
            <meta itemprop="userInteractionCount" content="0"/>
        </div>

    </div>


    <!-- :preload-content -->
    <footer class="noscript-footer-nav">
        <nav itemscope itemtype='http://schema.org/SiteNavigationElement'>
            <a href='../../index.html'>Home</a>
            <a href="../../categories.html">Categories</a>
            <a href="https://forum.stackstorm.com/guidelines">FAQ/Guidelines</a>
            <a href="../../tos.html">Terms of Service</a>
            <a href="../../privacy.html">Privacy Policy</a>
        </nav>
    </footer>
</div>

<footer id='noscript-footer'>
    <p>Powered by <a href="https://www.discourse.org">Discourse</a>, best viewed with JavaScript enabled</p>
</footer>


<section id='main'>
</section>


</body>
</html>
